db.orderdetails.updateMany(
  { OrderID: 11078 },
  { $inc: { Discount: 0.05 } }
)

---------------------------

db.orders.aggregate([
  { $match: { OrderID: 11078 } },
  { $lookup: {
        from: "customers",
        localField: "CustomerID",
        foreignField: "CustomerID",
        as: "Customer"
    }},
    { $unwind: "$Customer" },
  { $lookup: {
        from: "employees",
        localField: "EmployeeID",
        foreignField: "EmployeeID",
        as: "Employee"
    }},
    { $unwind: "$Employee" },
  {
    $lookup: {
      from: "orderdetails",
      localField: "OrderID",
      foreignField: "OrderID",
      as: "Orderdetails"
    }
  },
  {
    $unwind: "$Orderdetails"
  },
  { $lookup: {
        from: "shippers",
        localField: "ShipVia",
        foreignField: "ShipperID",
        as: "Shipper"
    }},
    { $unwind: { path: "$Shipper", preserveNullAndEmptyArrays: true } },
  {
    $lookup: {
      from: "products",
      localField: "Orderdetails.ProductID",
      foreignField: "ProductID",
      as: "Product"
    }
  },
  { $unwind: "$Product" },
  {
    $lookup: {
      from: "categories",
      localField: "Product.CategoryID",
      foreignField: "CategoryID",
      as: "Category"
    }
  },
  { $unwind: "$Category" },
  {
    $set: {
      "Orderdetails.product": {
        ProductID: "$Product.ProductID",
          ProductName: "$Product.ProductName",
          QuantityPerUnit: "$Product.QuantityPerUnit",
          CategoryID: "$Product.CategoryID",
          CategoryName: "$ProdCat.CategoryName"
      },
      "Orderdetails.Value": {
        $multiply: [
          "$Orderdetails.UnitPrice",
          "$Orderdetails.Quantity",
          { $subtract: [1, "$Orderdetails.Discount"] }
        ]
      }
    }
  },
  {
    $group: {
      _id: "$OrderID",
      OrderID: {$first: "$OrderID"},
      Customer: { $first: {
          CustomerID: "$Customer.CustomerID",
          CompanyName: "$Customer.CompanyName",
          City: "$Customer.City",
          Country: "$Customer.Country"
        }},
        Employee: { $first: {
          EmployeeID: "$Employee.EmployeeID",
          FirstName: "$Employee.FirstName",
          LastName: "$Employee.LastName",
          Title: "$Employee.Title"
        }},
      Dates: {
        $first: {
          OrderDate: "$OrderDate",
          RequiredDate: "$RequiredDate"
        }
      },
      Freight: { $first: "$Freight" },
      Shipment: { $first: {
          Shipper: {
            ShipperID: "$Shipper.ShipperID",
            CompanyName: "$Shipper.CompanyName"
          },
          ShipName: "$ShipName",
          ShipAddress: "$ShipAddress",
          ShipCity: "$ShipCity",
          ShipCountry: "$ShipCountry"
        }},
      Orderdetails: { $push: "$Orderdetails" },
      OrderTotal: { $sum: "$Orderdetails.Value" }
    }
  },
  {
    $merge: {
      into: "OrderInfo",
      on: "OrderID",
      whenMatched: "replace",
      whenNotMatched: "insert"
    }
  }
])


---------------------------

db.OrderInfo.aggregate([
  {
    $group: {
      _id: "$Customer.CustomerID",
      CustomerID: { $first: "$Customer.CustomerID" },
      CompanyName: { $first: "$Customer.CompanyName" },
      City: { $first: "$Customer.City" },
      Country: { $first: "$Customer.Country" },
      Orders: { $push: "$$ROOT" }
    }
  },
  {
    $unset: ["Orders.Customer"]
  },
  {
    $merge: {
      into: "CustomerInfo",
      on: "CustomerID",
      whenMatched: "replace",
      whenNotMatched: "insert"
    }
  }
])